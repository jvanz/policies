# This Updatecli manifest automates opening a pull request to prepare a policy
# project for release. It checks for required files, updates version
# information in metadata and Cargo files, and creates a GitHub pull request
# with appropriate labels and reviewers. The workflow ensures all
# release-related changes are made and ready for review before publishing.
name: Open PR that prepares the policy for release
pipelineid: "{{ .policy.working_dir }}"

conditions:
  checkCargoTomlExists:
    name: Check if Cargo.toml exists
    scmid: "policy-repo"
    kind: file
    disablesourceinput: true
    spec:
      file: "{{ .policy.working_dir }}/Cargo.toml"

targets:
  updateMetadataAnnotationVersion:
    name: Update metadata.yml with new version
    kind: yaml
    scmid: "policy-repo"
    disableconditions: true
    spec:
      searchpattern: true
      file: "{{ .policy.working_dir}}/metadata.y*ml"
      key: "$.annotations.'io.kubewarden.policy.version'"
      value: "{{ .policy.version }}"

  updateCargoTomlVersion:
    name: Update Cargo.toml, Cargo.lock with new version
    scmid: "policy-repo"
    dependson:
      - condition#checkCargoTomlExists
    kind: shell
    spec:
      shell: /usr/bin/bash
      command: "cargo set-version --package {{ .policy.rust_package }} {{ .policy.version }}"
      workdir: "{{ .policy.working_dir }}"
      changedif:
        kind: file/checksum
        spec:
          files:
            - "Cargo.toml"
            - "../Cargo.lock"

actions:
  openUpdatePR:
    title: "build: Prepare for release {{ .policy.working_dir }}"
    kind: "github/pullrequest"
    scmid: "policy-repo"
    spec:
      mergemethod: squash
      description: |
        Bumped versions to prepare for a release with version `{{ .policy.working_dir }}`.

        > [!NOTE]
        > Merging this PR will trigger a release of this policy.
      #     {{ if .pr.reviewrs }}
      reviewers:
        #           {{ range .pr.reviewers }}
        - "{{ . }}"
      #           {{ end }}
      #     {{ end }}
      #     {{ if .pr.labels }}
      labels:
        #           {{ range .pr.labels }}
        - "{{ . }}"
#           {{ end }}
#     {{ end }}

scms:
  policy-repo:
    kind: github
    spec:
      user: "{{ .github.git_author }}"
      email: "{{ .github.git_email }}"
      owner: "{{ .github.owner }}"
      repository: "{{ .github.repo }}"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ .github.owner }}"
      branch: "{{ .github.branch }}"
      commitusingapi: true # enable cryptographically signed commits
      commitmessage:
        type: "build"
        hidecredit: true
        footers: "Signed-off-by: {{ .github.git_author }} <{{ .github.git_email }}>"
