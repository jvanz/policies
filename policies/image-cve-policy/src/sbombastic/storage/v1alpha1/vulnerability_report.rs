#[derive(Clone, Debug, PartialEq, serde::Deserialize, serde::Serialize, schemars::JsonSchema)]
#[serde(rename_all = "camelCase")]
pub(crate) struct ImageMetadata {
    pub digest: String,
    pub platform: String,
    pub registry: String,
    #[serde(rename = "registryURI")]
    pub registry_uri: String,
    pub repository: String,
    pub tag: String,
}

impl k8s_openapi::DeepMerge for ImageMetadata {
    fn merge_from(&mut self, other: Self)
    where
        Self: Sized,
    {
        self.digest.merge_from(other.digest);
        self.platform.merge_from(other.platform);
        self.registry.merge_from(other.registry);
        self.registry_uri.merge_from(other.registry_uri);
        self.repository.merge_from(other.repository);
        self.tag.merge_from(other.tag);
    }
}

#[derive(
    Clone,
    Debug,
    PartialEq,
    k8s_openapi_derive::CustomResourceDefinition,
    serde::Deserialize,
    serde::Serialize,
    schemars::JsonSchema,
)]
#[custom_resource_definition(
    group = "storage.sbombastic.rancher.io",
    version = "v1alpha1",
    plural = "vulnerabilityreports",
    generate_schema,
    namespaced,
    has_subresources = "v1",
    impl_deep_merge
)]
#[serde(rename_all = "camelCase")]
pub(crate) struct VulnerabilityReportSpec {
    pub image_metadata: ImageMetadata,
    pub sarif: serde_json::Value,
}

impl k8s_openapi::DeepMerge for VulnerabilityReportSpec {
    fn merge_from(&mut self, other: Self)
    where
        Self: Sized,
    {
        self.image_metadata.merge_from(other.image_metadata);
        self.sarif.merge_from(other.sarif);
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn parse_vulnerability_report() {
        let vulnerability_report_yaml =
            include_bytes!("../../../../test_data/vulnerabilityreport_ubuntu_latest.yaml");

        let report: VulnerabilityReport =
            serde_yaml::from_slice(vulnerability_report_yaml).expect("cannot parse yaml");
        let report_spec = report.spec.expect("spec is missing");

        assert_eq!(
            report_spec.image_metadata.digest,
            "sha256:6169c4bcc1982095067d85edf58fdcc3bd8505aef728610c5b728f3cf1cec46b"
        );
        assert_eq!(report_spec.image_metadata.platform, "linux/amd64");
        assert_eq!(report_spec.image_metadata.registry, "my-first-registry");
        assert_eq!(
            report_spec.image_metadata.registry_uri,
            "docker-registry.default.svc.cluster.local"
        );
        assert_eq!(report_spec.image_metadata.repository, "ubuntu");
        assert_eq!(report_spec.image_metadata.tag, "latest");

        match report_spec.sarif {
            serde_json::Value::Object(sarif) => {
                assert!(!sarif.is_empty());
            }
            _ => panic!("sarif is not an object"),
        }
    }
}
