use std::fmt::{self, Display};

use thiserror::Error;

use crate::settings::SeverityCount;

/// Represents a violation of the max severity policy.
#[derive(Debug, Eq, Hash, PartialEq)]
pub(crate) struct Violation {
    /// The number of CVEs that are allowed. This also provides information about whether the
    /// presence of CVEs without fixes is required.
    pub allowed: SeverityCount,
    /// Number of CVEs found in the image.
    pub actual: u32,
    /// List of CVEs found in the image.
    pub vulnerabilities: Vec<String>,
}

impl Display for Violation {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        match self.allowed {
            SeverityCount::Total(max) => write!(
                f,
                "found {} CVEs, at most {max} could be tolerated",
                self.actual
            ),
            SeverityCount::TotalWithoutFixes(max) => write!(
                f,
                "found {} CVEs without fixes, at most {max} could be tolerated",
                self.actual
            ),
        }
    }
}

/// Represents the number of CVEs violations affecting an image.
#[derive(Debug, Eq, Hash, PartialEq, Default)]
pub(crate) struct CVEViolationStats {
    pub critical: Option<Violation>,
    pub high: Option<Violation>,
    pub medium: Option<Violation>,
    pub low: Option<Violation>,
}

impl Display for CVEViolationStats {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        if let Some(critical) = &self.critical {
            writeln!(f, "Critical: {critical}")?;
        }
        if let Some(high) = &self.high {
            writeln!(f, "High: {high}")?;
        }
        if let Some(medium) = &self.medium {
            writeln!(f, "Medium: {medium}")?;
        }
        if let Some(low) = &self.low {
            writeln!(f, "Low: {low}")?;
        }
        Ok(())
    }
}

impl CVEViolationStats {
    pub fn has_violations(&self) -> bool {
        self.critical.is_some()
            || self.high.is_some()
            || self.medium.is_some()
            || self.low.is_some()
    }
}

#[derive(Error, Debug, Eq, Hash, PartialEq)]
pub enum ImageValidationError {
    #[error(
        "Exceeded the CVSS score threshold: {threshold} with {max_count} CVEs, found {count} CVEs"
    )]
    CvssScoreThresholdExceeded {
        threshold: String,
        max_count: u32,
        count: usize,
    },

    #[error("Exceeded the number of allowed CVEs: {0}")]
    MaxSeverityExceeded(Box<CVEViolationStats>),

    #[error("Affected by the following CVEs that are always denied: {0:?}")]
    AffectedByDeniedCVE(Vec<String>),

    #[error("Doesn't have a VulnerabilityReport")]
    VulnerabilityReportNotFound(),

    #[error("Failed to fetch the image manifest: {0}")]
    ManifestFetchError(String),

    #[error("Failed to parse the image name: {0}")]
    MalformedImageName(String),
}
