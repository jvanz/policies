use k8s_openapi::api::{
    apps::v1::{DaemonSet, Deployment, ReplicaSet, StatefulSet},
    batch::v1::{CronJob, Job},
    core::v1::{Container, EphemeralContainer, Pod, PodSpec, ReplicationController},
};

/// Represents an abstraction of an struct that contains an image
/// Used to reuse code for Container and EphemeralContainer
pub(crate) trait ImageHolder: Clone {
    fn get_image(&self) -> Option<String>;
}

impl ImageHolder for Container {
    fn get_image(&self) -> Option<String> {
        self.image.clone()
    }
}

impl ImageHolder for EphemeralContainer {
    fn get_image(&self) -> Option<String> {
        self.image.clone()
    }
}

/// Represents all resources that can be validated with this policy
pub(crate) trait ValidatingResource {
    fn name(&self) -> String;
    fn spec(&self) -> Option<PodSpec>;
}

impl ValidatingResource for Pod {
    fn name(&self) -> String {
        self.metadata.name.clone().unwrap_or_default()
    }

    fn spec(&self) -> Option<PodSpec> {
        self.spec.clone()
    }
}

impl ValidatingResource for Deployment {
    fn name(&self) -> String {
        self.metadata.name.clone().unwrap_or_default()
    }

    fn spec(&self) -> Option<PodSpec> {
        self.spec.as_ref()?.template.spec.clone()
    }
}

impl ValidatingResource for ReplicaSet {
    fn name(&self) -> String {
        self.metadata.name.clone().unwrap_or_default()
    }

    fn spec(&self) -> Option<PodSpec> {
        self.spec.as_ref()?.template.as_ref()?.spec.clone()
    }
}

impl ValidatingResource for StatefulSet {
    fn name(&self) -> String {
        self.metadata.name.clone().unwrap_or_default()
    }

    fn spec(&self) -> Option<PodSpec> {
        self.spec.as_ref()?.template.spec.clone()
    }
}

impl ValidatingResource for DaemonSet {
    fn name(&self) -> String {
        self.metadata.name.clone().unwrap_or_default()
    }

    fn spec(&self) -> Option<PodSpec> {
        self.spec.as_ref()?.template.spec.clone()
    }
}

impl ValidatingResource for ReplicationController {
    fn name(&self) -> String {
        self.metadata.name.clone().unwrap_or_default()
    }

    fn spec(&self) -> Option<PodSpec> {
        self.spec.as_ref()?.template.as_ref()?.spec.clone()
    }
}

impl ValidatingResource for Job {
    fn name(&self) -> String {
        self.metadata.name.clone().unwrap_or_default()
    }

    fn spec(&self) -> Option<PodSpec> {
        self.spec.as_ref()?.template.spec.clone()
    }
}

impl ValidatingResource for CronJob {
    fn name(&self) -> String {
        self.metadata.name.clone().unwrap_or_default()
    }

    fn spec(&self) -> Option<PodSpec> {
        self.spec
            .as_ref()?
            .job_template
            .spec
            .as_ref()?
            .template
            .spec
            .clone()
    }
}
